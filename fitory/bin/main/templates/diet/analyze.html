<!DOCTYPE html>
<html layout:decorate="~{common}">
    <section layout:fragment="content">
        <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
        <h2>영양정보 분석</h2>
        <br>
        <h4>먹은 음식</h4>
        <input type="text" name="atefd" id="atefd" style="display: inline-block;">
        <input type="button" value="검색" onclick="search()">
        <section id="searchlist"></section>
        <br>
        <br>
        <table id="atefd_title" style="width: 600px;">
            <tr>
                <th style="width: 200px;">음식명</th>
                <th style="width: 65px;">칼로리</th>
                <th style="width: 65px;">탄수화물</th>
                <th style="width: 65px;">단백질</th>
                <th style="width: 65px;">지방</th>
                <th style="width: 65px;">당류</th>
                <th>염분</th>
            </tr>
        </table>
        <table id="atefd_content" style="width: 600px; height: 400px;">
        </table>
        <table id="total" style="width: 600px;">
            <tr>
                <th style="width: 200px;">총성분</th>
                <th style="width: 65px;" id="tcal">0</th>
                <th style="width: 65px;" id="tcarbo">0</th>
                <th style="width: 65px;" id="tpro">0</th>
                <th style="width: 65px;" id="tfat">0</th>
                <th style="width: 65px;" id="tsugar">0</th>
                <th id="tsod">0</th>
            </tr>
        </table>
        <script>
            const servicekey='jL8PHgOttipXdQtu%2BF4YntDmduAIvBCSdB7OP5VHXLcT8zpvkYvHRaPOAiwsFhAZVTG9hy%2FiVtBt%2Bqn7aQmT0w%3D%3D';
            const base='https://apis.data.go.kr/1471000/FoodNtrCpntDbInfo02';

            function search(){
                let selectfd=$('#atefd').val();
                console.log(selectfd);
                getname(selectfd);
            }

            function add(index){
                let data=document.getElementsByName("tmplist")[index].value;
                let item=JSON.parse(decodeURIComponent(atob(data)));
                let sentence1='<tr>';
                sentence1+='<td style="font-size: 13px; width: 170px;">'+item.FOOD_NM_KR+'</td>';
                sentence1+='<td style="font-size: 13px; width: 65px;">'+item.AMT_NUM1+'</td>';
                sentence1+='<td style="font-size: 13px; width: 65px;">'+item.AMT_NUM6+'</td>';
                sentence1+='<td style="font-size: 13px; width: 65px;">'+item.AMT_NUM3+'</td>';
                sentence1+='<td style="font-size: 13px; width: 65px;">'+item.AMT_NUM4+'</td>';
                sentence1+='<td style="font-size: 13px; width: 65px;">'+item.AMT_NUM7+'</td>';
                sentence1+='<td style="font-size: 13px; width: 65px;">'+item.AMT_NUM13+'</td></tr>';
                $('#atefd_content').append(sentence1);
                let tcal=Number($("#tcal").html())+Number(item.AMT_NUM1);
                $('#tcal').html(tcal);
                let tcarbo=Number($("#tcarbo").html())+Number(item.AMT_NUM6);
                $('#tcarbo').html(tcarbo.toFixed(2));
                let tpro=Number($("#tpro").html())+Number(item.AMT_NUM3);
                $('#tpro').html(tpro.toFixed(2));
                let tfat=Number($("#tfat").html())+Number(item.AMT_NUM4);
                $('#tfat').html(tfat.toFixed(2));
                let tsugar=Number($("#tsugar").html())+Number(item.AMT_NUM7);
                $('#tsugar').html(tsugar.toFixed(2));
                let tsod=Number($("#tsod").html())+Number(item.AMT_NUM13);
                $('#tsod').html(tsod.toFixed(2));
                $('#searchlist').html('');
            }

            async function getname(foodname) {
                let url=base+'/getFoodNtrCpntDbInq02?serviceKey='+servicekey+'&type=json&FOOD_NM_KR='+foodname+'&DB_CLASS_NM=품목대표';
                try {
                    const response= await fetch(url);
                    const inform= await response.json();
                    const items=inform.body.items;
                    let tempsnt='';
                    $.each(items,function(index,item){
                        tempsnt+='<span onclick="add('+index+')" style="border: 2px solid; cursor: pointer; display: inline-block;">'+item.FOOD_NM_KR+'('+item.FOOD_OR_NM+')'+'</span>&ensp;';
                        tempsnt+='<input type="hidden" name="tmplist" value='+btoa(encodeURIComponent(JSON.stringify(item)))+'>';
                    })
                    if(tempsnt==''){
                        tempsnt='해당 검색어에 대한 정보가 없습니다.';
                    }
                    $('#searchlist').html(tempsnt);
                } catch (error) {
                    alert('오류');
                    console.log(error);
                }
            }

        </script>
    </section>
</html>
</html>